/* devicemanagement_location 8.21.0 2018-01-30T22:08:29+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
angular.module("c8y.parts.location",["leaflet-directive"]).config(["c8yViewsProvider","c8yComponentsProvider","gettext",function(n,e,t){function a(n,e,a,l){var i=n.deviceId,c="/device/"+i+"/location",s=a.detailCached(i).then(function(n){var e=n.data,t="c8y_Position",a="com_nsn_startups_vendme_fragments_GPSCoordinates",o=e[t]||e[a];return o});return s.then(function(n){n||l.addAction({text:t("Add location"),priority:1e3,showIfPermissions:{adminMOs:[i]},action:function(){a.save({id:i,c8y_Position:_.cloneDeep(o)}).then(function(){e.path(c)})}})}),s}var o={lat:51.2433101,lng:6.7303924};n.when("/device/:deviceId",{name:t("Location"),templateUrl:"devicemanagement_location/views/index.html",icon:"location-arrow",showIf:["$routeParams","$location","c8yDevices","c8yActions",a]}),e.add({name:t("Location"),description:t("Displays a map with device position marker"),templateUrl:"devicemanagement_location/views/component.html",options:{noNewWidgets:!0}})}]),angular.module("c8y.parts.location").controller("locationCtrl",["$scope","$routeParams","c8yBase","c8yGeo","c8yDevices","c8yRealtime","c8yAlert","gettext",function(n,e,t,a,o,l,i,c){"use strict";function s(e){L=e;var t=n.location=y(e)||{};r(n.location),I=_.clone(t),u(t)&&g(t)}function r(n){_.set(n,"lat",_.toNumber(_.get(n,"lat"))),_.set(n,"lng",_.toNumber(_.get(n,"lng")))}function d(n,e){f(e.model)}function m(n){if(n){var e={lat:Number(n.lat),lng:Number(n.lon),zoom:17};g(e),f(e),w(e)}}function u(n){return!(!n.lat||!n.lng)}function p(){return n.child&&n.child.config&&n.child.config.device&&(R.draggable=!1),n.child&&n.child.config&&n.child.config.device&&n.child.config.device.id||e.deviceId}function v(){o.detailCached(p()).then(function(n){return _.cloneDeep(n.data)}).then(s)}function g(n){_.assign(R,{lat:parseFloat(n.lat),lng:parseFloat(n.lng)}),G.main=R,w(R)}function b(n){return n%=360,n<-180?n+360:n>180?n-360:n}function f(e){_.assign(n.location,{lat:parseFloat(e.lat),lng:b(parseFloat(e.lng))})}function h(n){return o.isVendme(n)?N:E}function y(n){return n[h(n)]}function w(e){var t=e||R;n.center=n.center,_.assign(n.center,t)}function k(n){a.geoCode(n).then(function(n){return 0===n.data.length&&i.warning(c("Address could not be found!")),n.data[0]||null}).then(m)}function C(){n.noeditable=!n.noeditable,_.isEqual(n.location,I)||(n.location=_.clone(I))}function x(){n.noeditable=!n.noeditable;var e={id:L.id},t=_.clone(y(L));delete t.address,e[h(L)]=t,$(e[h(L)]),o.save(e).then(function(){i.success(c("Location successfully saved!"))}).then(v)}function $(n){_.set(n,"lat",_.get(n,"lat").toString()),_.set(n,"lng",_.get(n,"lng").toString())}function D(n,e){s(e)}function A(n,e){s(e)}function F(){v()}function P(){z?n.switchRealtime():v()}var L,I,E="c8y_Position",N="com_nsn_startups_vendme_fragments_GPSCoordinates",S={latitude:/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/,longitude:/^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/,altitude:/^[-+]?(0|([1-9]\d*))(\.\d+)?$/},z=!1,M=11,q={},G={},R={focus:!0,draggable:!0},U={scrollWheelZoom:!1},T={lat:0,lng:0,zoom:M},V={markers:["dragend"]};n.settings=q,n.markers=G,n.mapDefaults=U,n.centerMap=w,n.center=T,n.pattern=S,n.$on("leafletDirectiveMarker.dragend",d),n.events=V,n.gotoAddress=k,n.cancel=C,n.save=x,n.realtimeChannel="/managedobjects/"+(void 0!==e.deviceId?e.deviceId:"*"),n.invalid=angular.bind(t,t.invalid,n),n.$watch("child.config.device",v),l.addListener(n.$id,n.realtimeChannel,n.$id+"-subscribed",F),l.addListener(n.$id,n.realtimeChannel,"CREATE",D),l.addListener(n.$id,n.realtimeChannel,"UPDATE",A),P()}]),function(){"use strict";function n(n){var e;e='<div data-ng-controller="locationCtrl">\n<leaflet width="100%" height="250px" markers="markers" center="center" defaults="mapDefaults" event-broadcast="events"></leaflet>\n</div>',n.put("devicemanagement_location/views/component.html",e),n.put("/apps/devicemanagement/location/views/component.html",e),e='<div data-ng-controller="locationCtrl">\n\n  <c8y-ui-action-bar-set>\n      <c8y-realtime-btn class="btn btn-link" style="margin-left: -12px"></c8y-realtime-btn>\n\n      <button class="btn btn-link" title="{{\'Center map\' | translate}}" ng-click="centerMap()">\n        <i c8y-icon="dot-circle-o"></i> {{\'Center map\' | translate}}\n      </button>\n  </c8y-ui-action-bar-set>\n\n  <div class="row">\n    <div class="col-md-8">\n      <leaflet width="100%" height="600px" style="margin-bottom:15px" markers="markers" center="center" defaults="mapDefaults" event-broadcast="events"></leaflet>\n    </div>\n\n    <div class="col-md-4">\n      <div class="card">\n        <div class="card-header">\n          <span class="h4 card-title" translate>Current location</span>\n          <div class="flex-item-right" ng-show="!noeditable">\n            <small>\n              <a href="" class="text-gray" ng-click="noeditable = !noeditable" translate>\n                Edit location\n              </a>\n            </small>\n            <a tabindex="0" uib-popover-html="\'Device location may be set by the device itself, or manually in the platform\' | translate" popover-append-to-body="true" popover-placement="left" popover-trigger="\'focus\'" style="display:inline-block">\n              <i c8y-icon="question-circle-o"></i>\n            </a>\n          </div>\n        </div>\n        <hr>\n        <div class="card-block" ng-class="{\'form-read-only\': !noeditable}">\n          <form name="locationForm" novalidate class="form-horizontal">\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'latitude\')}">\n              <label class="col-sm-4 control-label"><span translate>Latitude</span> (°)</label>\n              <div class="col-sm-8">\n                <input type="number" name="latitude" class="form-control" ng-model="location.lat" ng-pattern="pattern.latitude">\n              </div>\n            </div>\n\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'longitude\')}">\n              <label class="col-sm-4 control-label"><span translate>Longitude</span> (°)</label>\n              <div class="col-sm-8">\n                <input type="number" name="longitude" class="form-control" ng-model="location.lng" ng-pattern="pattern.longitude">\n              </div>\n            </div>\n\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'altitude\')}">\n              <label class="col-sm-4 control-label"><span translate>Altitude</span> <span class="text-lowercase">(m)</span></label>\n              <div class="col-sm-8">\n                <input type="number" name="altitude" class="form-control" ng-model="location.alt" ng-pattern="pattern.altitude">\n              </div>\n            </div>\n          </form>\n        </div>\n\n        <hr ng-show="noeditable" style="margin-bottom: 20px">\n\n        <div class="form-horizontal" style="padding: 0 20px">\n          <div class="form-group">\n            <form name="addressForm" ng-show="noeditable" novalidate ng-submit="gotoAddress(location.address)">\n              <label class="control-label col-sm-3" translate>Address</label>\n              <div class="col-sm-9">\n                <div class="input-group input-group-search">\n                  <input type="text" ng-model="location.address" placeholder="{{\'Find lat/long by address\' | translate}}" class="form-control">\n                  <span class="input-group-btn">\n                    <button class="btn btn-link" type="submit">\n                      <i c8y-icon="search"></i>\n                    </button>\n                  </span>\n                </div>\n              </div>\n            </form>\n          </div>\n        </div>\n\n        <hr>\n\n        <div class="card-footer" ng-show="noeditable">\n          <button class="btn btn-default" ng-click="cancel()" translate>Cancel</button>\n          <button class="btn btn-primary" ng-disabled="locationForm.$invalid" ng-click="save()" translate>Save</button>\n\n          <!-- <div ng-show="!noeditable">\n            <button class="btn btn-default" ng-click="noeditable = !noeditable"><i c8y-icon="pencil"></i> Edit location</button>\n            <span class="">\n              <a tabindex="0" uib-popover-html="\'Device location may be set by the device itself, or manually in the platform\' | translate" popover-append-to-body="true" popover-placement="left" popover-trigger="\'focus\'" style="display:inline-block;">\n                <i c8y-icon="question-circle-o"></i>\n              </a>\n            </span>\n          </div> -->\n        </div>\n      </div>\n\n    </div>\n  </div>\n\n</div>\n',n.put("devicemanagement_location/views/index.html",e),n.put("/apps/devicemanagement/location/views/index.html",e)}angular.module("c8y.parts.location").run(["$templateCache",n])}();