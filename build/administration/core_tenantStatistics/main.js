/* core_tenantStatistics 9.3.0 2018-03-26T16:26:31+00:00 796b68a031b1+ (release/9.3.0) tip */
!function(){"use strict";function t(t,e,n){t.addNavigation({parent:n("Tenants"),name:n("Usage statistics"),path:"tenantStatistics",icon:"c8y-usage-statistics",showIf:["c8yUserUtil",function(t){return t.showTenantManagement()}]}),e.when("/tenantStatistics",{templateUrl:"core_tenantStatistics/views/list.html",controller:"tenantStatisticsListCtrl",controllerAs:"vm"})}t.$inject=["c8yNavigatorProvider","c8yViewsProvider","gettext"],angular.module("c8y.tenantStatistics",["c8y.csvExporter"]).config(t)}(),function(){"use strict";function t(t,e,n,i,o,r,a,s,c,u,l,m,d,p,g){function f(){h(),C().then(x).then(z).then(D).then(B)}function h(){N.dateFrom=t.dateFrom=u.stringToDate(n.dateFrom)||U,N.dateTo=t.dateTo=u.stringToDate(n.dateTo)}function C(){return a.list(v()).then(y)}function v(){return{dateFrom:u.dateToString(N.dateFrom),dateTo:u.dateToString(N.dateTo)}}function y(e){return t.formattedStatistics=P(e),t.statistics=S(e),M(e.length),e}function P(t){var e=_.cloneDeep(t);return e=o("orderBy")(e,"tenantId"),_.map(e,function(t){return t.storageSize=b(t),t.subscribedApplications=_.filter(t.subscribedApplications),t})}function b(e){var n;return n=t.storageLimitFeatureEnabled&&e.storageLimitPerDevice?[o("bytes")(e.storageSize),o("bytes")(I(e.storageLimitPerDevice,e.deviceWithChildrenCount))].join("/"):o("bytes")(e.storageSize)}function S(t){return _.forEach(t,function(t){t.storageSize=T(t.storageSize),t.storageLimitPerDevice&&(t.storageLimitPerDevice=T(t.storageLimitPerDevice))}),t}function T(t){return Number((t/Math.pow(2,20)).toFixed(2))}function x(){var e="c8ySchema!!customProperties";return j.list().then(function(t){return _.filter(t,{id:e})}).then(function(t){return j.getSchema(t)}).then(function(t){var e=_.get(t,"properties.customProperties.properties",{});return _.map(e,function(t,e){return{title:t.title,key:e,schema:t}})}).then(function(e){t.customProperties=_.sortBy(e,"title")})}function D(){t.columns=F(),t.columnsConfig={},N.csvHeaders=t.csvHeaders=_.map(t.columns,function(t){return _.get(t,"header.csv")||_.get(t,"header.text")||_.get(t,"header")})}function B(e){t.columnsConfig=e,t.filteredSortedStatistics=d.filterSort(t.formattedStatistics,t.columns,t.columnsConfig)}function F(){var e=[m.getTenantIdColumn(),q(),m.getApiRequestsColumn(),m.getDeviceApiRequestsColumn(),t.storageLimitFeatureEnabled?m.getStorageQuotaEnabledColumn():null,m.getStorageSizeColumn(),m.getRootDevicesColumn(),m.getDevicesColumn(),m.getDeviceEndpointCountColumn(),m.getSubscribedApplicationsColumn(),m.getCreationTimeColumn(),t.isTopTenant?m.getParentTenantIdColumn():null];return _.filter(_.flattenDeep(e))}function q(){return _.map(t.customProperties,function(t){return m.getCustomPropertyColumn(t)})}function k(){var e=d.filterSort(t.statistics,t.columns,t.columnsConfig);return _.map(e,E)}function E(e){var n=[];return n.push(e.tenantId),_.forEach(t.customProperties,function(t){n.push($(e,t))}),n.push(e.requestCount),n.push(e.deviceRequestCount),t.storageLimitFeatureEnabled&&n.push(I(e.storageLimitPerDevice,e.deviceWithChildrenCount)||g.getString("Disabled")),n.push(e.storageSize),n.push(e.deviceCount),n.push(e.deviceWithChildrenCount),n.push(e.deviceEndpointCount),n.push((e.subscribedApplications||[]).join(" ")),n.push(e.creationTime&&moment(e.creationTime).format("L")),t.isTopTenant&&n.push(e.parentTenantId),n}function I(t,e){var n=t;return n&&(n*=e||1),n}function L(){_.isEqual(v().dateFrom,U)&&_.isUndefined(v().dateTo)||i.search(v())}function M(t){var e=g.getPlural(t,"1 tenant","{{$count}} tenants",{});c.changeTitle({title:p("Tenants usage statistics"),subtitle:_.isNumber(t)?e:""})}function A(){i.search({})}function R(t){i.path("/tenants/"+t.tenantId)}function w(){f()}function z(){return s.isCurrentUserTopTenant().then(function(e){return t.isTopTenant=e,e})}function $(t,e){var n=_.get(e,"schema.default");return _.get(t,["tenantCustomProperties",e.key],n)}function W(t){B(t)}var N=this,U=u.stringToDate(r.fromThisMonthStartFilter().dateFrom),j=l.another(l.paths.Tenants),V=p("No tenants to display.");t.statistics=[],N.filter=t.filter=L,N.clearFilter=t.clearFilter=A,t.detail=R,t.refresh=w,t.csvData=k,t.storageLimitFeatureEnabled=r.appOption("storageLimitationFeatureEnabled"),t.getTenantCustomPropertyValue=$,t.onColumnsConfigChanged=W,t.noItemsMessage=V,f()}t.$inject=["$scope","$q","$routeParams","$location","$filter","c8yBase","c8yStatistics","c8yTenant","c8yTitle","c8yUtil","c8yPropertiesLibrary","c8yTenantStatisticsColumns","c8yFilteringSortingCollections","gettext","gettextCatalog"],angular.module("c8y.tenantStatistics").controller("tenantStatisticsListCtrl",t)}(),function(){"use strict";function t(t,e,n){function i(){return t.getColumn({name:"tenantId",header:n("Id"),cell:{template:"{{item.tenantId}}"},filteringByPattern:{itemProperty:"tenantId"},sortingByPath:{itemProperty:"tenantId"}})}function o(e){var n=e.key,i=["tenantCustomProperties",n],o={name:n,header:{text:e.title,csv:"externalReference"===n?e.title:n},cell:{template:"<div\n              ng-bind-html=\"getValue(item, '"+n+"') | formatBySchema:getSchema(tenantCustomProperties, '"+n+"')\"\n            >\n            </div>",scopeExtensions:{getValue:function(t,e){return _.get(t,["tenantCustomProperties",e])},getSchema:function(t,e){return _.get(t,[e,"schema"])}}}};return _.merge(o,r(e)),_.set(o.cell.scopeExtensions,i,e),t.getColumn(o)}function r(t){var n=e.getType(t),i=n.filteringKey,o="sortingByPath",r=["tenantCustomProperties",t.key],a={itemProperty:r},s={};return _.set(s,i,a),_.set(s,o,a),s}function a(){return t.getColumn({name:"requestCount",header:n("API requests"),cell:{template:"{{item.requestCount}}"},filteringByMinMax:{itemProperty:"requestCount"},sortingByPath:{itemProperty:"requestCount"}})}function s(){return t.getColumn({name:"deviceRequestCount",header:n("Device API requests"),cell:{template:"{{item.deviceRequestCount}}"},filteringByMinMax:{itemProperty:"deviceRequestCount"},sortingByPath:{itemProperty:"deviceRequestCount"}})}function c(){return t.getColumn({name:"storageLimitPerDevice",header:{text:n("Storage quota"),csv:n("Storage quota (MB)")},cell:{template:'<input type="checkbox" disabled="true" ng-checked="!!item.storageLimitPerDevice">'},filteringByBoolean:{itemProperty:"storageLimitPerDevice"},sortingByPath:{itemProperty:"storageLimitPerDevice"}})}function u(){return t.getColumn({name:"storageSize",header:{text:n("Storage"),tooltip:{icon:"question-circle-o",text:n("When a storage quota is set, total used storage over storage quota is displayed")},csv:n("Storage (MB)")},cell:{template:"{{item.storageSize}}"},filteringByMinMax:{itemProperty:"storageSize"}})}function l(){return t.getColumn({name:"deviceCount",header:{text:n("Root devices"),tooltip:{icon:"question-circle-o",text:n("Number of root devices, excluding child devices")}},cell:{template:"{{item.deviceCount}}"},filteringByMinMax:{itemProperty:"deviceCount"},sortingByPath:{itemProperty:"deviceCount"}})}function m(){return t.getColumn({name:"deviceWithChildrenCount",header:{text:n("Devices"),tooltip:{icon:"question-circle-o",text:n("Number of devices, including child devices")}},cell:{template:"{{item.deviceWithChildrenCount}}"},filteringByMinMax:{itemProperty:"deviceWithChildrenCount"},sortingByPath:{itemProperty:"deviceWithChildrenCount"}})}function d(){return t.getColumn({name:"subscribedApplications",header:n("Subscribed applications"),cell:{template:"{{(item.subscribedApplications || []).length}}"},filteringByMinMax:{itemProperty:"subscribedApplications.length"},sortingByPath:{itemProperty:"subscribedApplications.length"}})}function p(){return t.getColumn({name:"creationTime",header:n("Creation time"),cell:{template:"{{item.creationTime | absoluteDate}}"},filteringByMinMaxDate:{itemProperty:"creationTime"},sortingByPath:{itemProperty:"creationTime"}})}function g(){return t.getColumn({name:"parentTenantId",header:n("Parent tenant"),cell:{template:"{{item.parentTenantId}}"},filteringByPattern:{itemProperty:"parentTenantId"},sortingByPath:{itemProperty:"parentTenantId"}})}function f(){return t.getColumn({name:"deviceEndpointCount",header:{text:n("Endpoint devices"),tooltip:{icon:"question-circle-o",text:n("Leaf machines (without gateways and edges)")}},cell:{template:"{{item.deviceEndpointCount}}"},filteringByPattern:{itemProperty:"deviceEndpointCount"},sortingByPath:{itemProperty:"deviceEndpointCount"}})}return{getTenantIdColumn:i,getCustomPropertyColumn:o,getApiRequestsColumn:a,getDeviceApiRequestsColumn:s,getStorageQuotaEnabledColumn:c,getStorageSizeColumn:u,getRootDevicesColumn:l,getDevicesColumn:m,getSubscribedApplicationsColumn:d,getCreationTimeColumn:p,getParentTenantIdColumn:g,getDeviceEndpointCountColumn:f}}t.$inject=["c8yFilteringSortingCollections","SchemaPropertiesSvc","gettext"],angular.module("c8y.tenantStatistics").factory("c8yTenantStatisticsColumns",t)}(),function(){"use strict";function t(t){var e;e='<c8y-ui-action-bar-set>\n  <li class="navbar-form" action-bar-position="left">\n    <form class="form-inline">\n      <label style="padding-right: 5px" translate>Statistic period:</label>\n      <div class="form-group datepicker">\n        <input class="form-control" placeholder="{{\'From`date`\' | translate}}" datepicker-options="{maxDate: vm.dateTo}" ng-model="vm.dateFrom" uib-datepicker-popup is-open="openFrom" ng-click="openFrom=true" style="width: 120px; text-align: center">\n      </div>\n      <div class="form-group datepicker">\n        <input class="form-control" placeholder="{{\'To`date`\' | translate}}" datepicker-options="{minDate: vm.dateFrom}" ng-model="vm.dateTo" uib-datepicker-popup is-open="openTo" ng-click="openTo=true" style="width: 120px; text-align: center">\n      </div>\n      <button type="button" class="btn btn-link" ng-click="vm.filter()" title="{{\'Filter\' | translate}}"><i c8y-icon="filter"></i> <span translate>Filter</span></button>\n      <button type="button" class="btn btn-link" ng-click="vm.clearFilter()" ng-show="vm.dateFrom || vm.dateTo" title="{{\'Clear\' | translate}}"><i c8y-icon="times"></i> <span translate>Clear</span></button>\n    </form>\n  </li>\n\n  <a c8y-csv-exporter c8y-data="csvData()" c8y-headers="vm.csvHeaders" href="" class="btn btn-link">\n    <i c8y-icon="table"></i> {{\'Export CSV\' | translate}}\n  </a>\n\n  <button type="button" class="btn btn-link" ng-click="refresh()">\n    <i c8y-icon="refresh" ng-class="{\'fa-spin\': refreshLoading}"></i> {{\'Reload\' | translate}}\n  </button>\n</c8y-ui-action-bar-set>\n\n\n<div>\n  <div>\n\n  </div>\n\n  <c8y-filtered-sorted-list columns="columns" columns-config="columnsConfig" on-columns-config-changed="onColumnsConfigChanged(columnsConfig)" items="filteredSortedStatistics" no-items-message="noItemsMessage" on-item-click="detail(item)">\n  </c8y-filtered-sorted-list>\n</div>\n',t.put("core_tenantStatistics/views/list.html",e),t.put("/apps/core/tenantStatistics/views/list.html",e)}angular.module("c8y.tenantStatistics").run(["$templateCache",t])}();