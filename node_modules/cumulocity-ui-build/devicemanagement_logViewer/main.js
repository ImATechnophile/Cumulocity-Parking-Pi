/* devicemanagement_logViewer 8.21.0 2018-01-30T22:08:29+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
angular.module("c8y.logViewer",[]),function(){"use strict";function e(e,n,t,i,o,l,s,a,c,r,d){function u(){f().then(g),m()}function g(){A.filters=e.filters={dateFrom:moment().subtract(1,"day"),dateTo:moment(),logFile:e.logTypes[0]&&e.logTypes[0].name||null,maximumLines:1e3}}function f(){return o.detail(n.deviceId).then(t.getResData).then(function(n){A.logTypes=e.logTypes=_.map(n.c8y_SupportedLogs,function(e){return{name:e}})})}function m(e){var t=_.assign({deviceId:n.deviceId,fragmentType:"c8y_LogfileRequest",withTotalPages:!0},e);return l.list(t).then(p)}function p(n,t){e.operations&&!t||(e.operations=[]),n.forEach(function(n){e.operations.push(n)}),e.paging=n.paging}function y(n){e.paging.loading=!0;var t=n?m({pageSize:n}):e.paging.next().then(p);t.finally(function(){e.paging.loading=!1})}function v(){_.get(e.paging,"refresh")&&(e.realtimeAnimation=!1,e.refreshLoading=!0,e.paging.refresh().then(_.partialRight(p,!0)).finally(function(){e.refreshLoading=!1}),e.paging=null)}function h(e){return l.getStyle(e).icon}function L(e){return l.getStyle(e).cls}function b(e){if(e.c8y_LogfileRequest.file){var n=i.getIdFromUrl(e.c8y_LogfileRequest.file);if(n)return i.downloadAndSaveAs(n).catch(function(){c.danger(r("The file is not available!"))})}}function w(e){if("PENDING"===e.status)return l.cancel(e).then(_.partial(c.success,r("Cancelled log file request!"))).then(v)}function R(e){return a({title:r("Confirm removing log"),body:r("Do you really want to remove this log?"),status:"danger"}).then(_.partial(q,e)).finally(_.partial(x,e)).then(_.partial(c.success,r("Log file successfully removed!"))).then(v)}function q(e){if(e.c8y_LogfileRequest.file){var n=i.getIdFromUrl(e.c8y_LogfileRequest.file);if(n)return i.removeBinary(n)}}function x(e){var n={id:e.id,status:e.status,c8y_LogfileRequest:null};return l.save(n)}function T(n){F(n)?e.selectedLog=n:e.selectedLog=void 0}function F(e){return e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file}function D(e){var t={deviceId:n.deviceId,description:r("Log file request"),c8y_LogfileRequest:{dateFrom:moment(e.dateFrom).format(B),dateTo:moment(e.dateTo).format(B),logFile:e.logFile,searchText:e.searchText||"",maximumLines:e.maximumLines}};l.createWithNotifications(t).then(function(e){e.created.then(v),e.completed.then(function(e){e.status===l.status.SUCCESSFUL?(_.assign(t,e),T(t)):e.status===l.status.FAILED&&"Operation cancelled by user."!==e.failureReason&&(e.failureReason?c.danger(d('Could not load file because of reason: "{{failureReason}}"!',{failureReason:d.getString(e.failureReason)})):c.danger(r("Could not load file!")))},_.noop,function(e){_.assign(t,e),T(t)}).then(v)})}function I(e){return e&&"SUCCESSFUL"===e.status}function k(e){return e&&"PENDING"===e.status}function C(e){return e&&"FAILED"===e.status}function $(e){return I(e)||C(e)}function S(e){return e&&e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file&&!!i.getIdFromUrl(e.c8y_LogfileRequest.file)}function V(e){return e.description||r("no description available")}var A=this,B="YYYY-MM-DDTHH:mm:ssZZ";e.requestLogfile=D,e.hasLogFile=F,e.selectLogfile=T,e.isBinary=S,e.download=b,e.cancel=w,e.remove=R,e.statusIcon=h,e.statusClass=L,e.isSuccessful=I,e.isPending=k,e.isFailed=C,e.isCompleted=$,e.refresh=v,e.loadNext=y,e.getOperationDesc=V,u();var E=e.$id,P="/operations/"+n.deviceId,U=s.realtimeActions();_.forOwn(U,function(n){s.addListener(E,P,n,function(n,t){if(_.has(t,"c8y_LogfileRequest")){v();var i=e.selectedLog;i&&i.id===t.id&&n===U.UPDATE&&(i.c8y_LogfileRequest=t.c8y_LogfileRequest)}})}),s.start(E,P),e.$on("$destroy",function(){s.stop(E,P),s.destroySubscription(E,P)})}e.$inject=["$scope","$routeParams","c8yBase","c8yBinary","c8yDevices","c8yDeviceControl","c8yRealtime","c8yModal","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.logViewer").controller("logViewerCtrl",e)}(),function(){"use strict";function e(e,n){function t(e,n,t){var i;return i=e.deviceId,n.detailCached(i).then(t.getResData).then(function(e){return n.supportsOperation(e,"c8y_LogfileRequest")})}function i(n,i){e.when(n,_.assign(i,{showIf:["$routeParams","c8yDevices","c8yBase",t]}))}function o(e){var t,i;return e&&e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file?(t=e.c8y_LogfileRequest.file,i=c.getIdFromUrl(t),i?c.downloadAsText(i):s.get(t)):a.when({data:n("Loading logfiles...")})}function l(e,n,t){return s=e,a=n,c=t,{getLogfile:o}}var s,a,c;return{$get:["$http","$q","c8yBinary",l],when:i,showIf:t}}e.$inject=["c8yViewsProvider","gettext"],angular.module("c8y.logViewer").provider("logViewer",e)}(),function(){"use strict";function e(e,n,t){function i(i,o){function l(i){e.getLogfile(i).then(function(e){o.text(e.data)}).catch(function(){n.danger(t("The file is no longer available."))})}i.$watch("selectedLog",l,!0)}return{restrict:"E",replace:!0,template:'<pre style="max-height: 300px; overflow:auto;"></pre>',link:i}}e.$inject=["logViewer","c8yAlert","gettext"],angular.module("c8y.logViewer").directive("c8yLogViewer",e)}(),function(){"use strict";function e(e,n){e.when("/device/:deviceId",{name:n("Logs"),templateUrl:"devicemanagement_logViewer/views/index.html",icon:"file-text-o"})}angular.module("c8y.logViewer").config(["logViewerProvider","gettext",e])}(),function(){"use strict";function e(e){var n;n='<div class="log-viewer" ng-controller="logViewerCtrl as vm">\n\n  <c8y-ui-action-bar-set>\n    <li>\n      <div class="dropdown" uib-dropdown auto-close="outsideClick" is-open="isOpen">\n        <button class="dropdown-toggle c8y-dropdown" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false">\n          <i c8y-icon="plus-square"></i> <span translate>Request log file</span> <span class="caret"></span>\n        </button>\n        <ul class="dropdown-menu dropdown-menu-right" uib-dropdown-menu>\n          <li class="dropdown-form" style="width: 283px">\n            <form name="logRequestForm" class="form">\n\n              <div class="form-group c8y-datetime-picker">\n                <label>{{\'From`date`\' | translate}}</label>\n                <c8y-date-time-picker ng-model="vm.filters.dateFrom" placeholder="{{\'From`date`\' | translate}}" max-date="vm.filters.dateTo" append-to-body="true"></c8y-date-time-picker>\n              </div>\n\n              <div class="form-group c8y-datetime-picker">\n                <label>{{\'To`date`\' | translate}}</label>\n                <c8y-date-time-picker ng-model="vm.filters.dateTo" placeholder="{{\'To`date`\' | translate}}" min-date="vm.filters.dateFrom" append-to-body="true"></c8y-date-time-picker>\n              </div>\n\n              <div class="form-group">\n                <label translate>Type of log</label>\n                <ui-select ng-model="vm.filters.logFile" required>\n                  <ui-select-match placeholder="{{\'Type of log\' | translate}}">{{$select.selected.name}}</ui-select-match>\n                  <ui-select-choices repeat="logType.name as logType in vm.logTypes | filter: $select.search | orderBy:\'name\'">\n                    <div ng-bind-html="logType.name | highlight: $select.search"></div>\n                  </ui-select-choices>\n                </ui-select>\n              </div>\n\n              <div class="form-group">\n                <label translate>Filter by text</label>\n                <input class="form-control" placeholder="{{\'Filter by text\' | translate}}" ng-model="vm.filters.searchText" ng-trim="false"/>\n              </div>\n\n              <div class="form-group">\n                <label translate>Last lines to display</label>\n                <input type="number" class="form-control" ng-model="vm.filters.maximumLines" required/>\n              </div>\n              <button class="btn btn-primary btn-block" ng-disabled="logRequestForm.$invalid" ng-click="requestLogfile(vm.filters); isOpen =  !isOpen" translate>Request log</button>\n            </form>\n          </li>\n        </ul>\n      </div>\n    </li>\n\n    <c8y-refresh-btn></c8y-refresh-btn>\n  </c8y-ui-action-bar-set>\n\n  <div class="c8y-empty-state text-center" ng-hide="operations">\n    <h1 class="c8y-icon c8y-icon-energy c8y-icon-duocolor"></h1>\n    <h3 translate="">No logs found.</h3>\n  </div>\n\n  <div class="list-group">\n    <div class="list-group-item collapsible" ng-repeat="op in operations | orderBy:\'-creationTime\'" ng-class="{\'expanded\': op===selectedLog }">\n\n    <div class="flex-row" ng-class="{\'realtime-animation-list\': realtimeAnimation}">\n\n      <div class="list-item-actions">\n\n        <button class="btn btn-link" uib-tooltip="{{\'Cancel operation\' | translate}}" tooltip-append-to-body="true" ng-click="cancel(op)" ng-if="isPending(op)">\n          <i c8y-icon="times"></i>\n        </button>\n\n        <button type="button" title="{{\'Expand\' | translate}}" class="collapse-btn" ng-if="hasLogFile(op)" ng-class="{\'active\':op===selectedLog }" ng-click="op===selectedLog ? selectLogfile({}) :selectLogfile(op);">\n          <i c8y-icon="chevron-down"></i>\n        </button>\n        <span class="dropdown settings" is-open="isopen" uib-dropdown ng-if="hasLogFile(op)">\n          <button class="dropdown-toggle c8y-dropdown btn-link" uib-dropdown-toggle>\n              <i c8y-icon="ellipsis-v"></i>\n          </button>\n          <ul class="dropdown-menu dropdown-menu-right" uib-dropdown-menu>\n            <li ng-if="isSuccessful(op)">\n              <a href ng-click="remove(op)">\n                <i c8y-icon="times"></i> {{\'Remove log\' | translate}}\n              </a>\n            </li>\n            <li ng-show="isBinary(op)">\n              <a href ng-click="download(op)">\n                <i c8y-icon="download"></i> {{\'Download\' | translate}}\n              </a>\n            </li>\n            <li ng-hide="isBinary(op) || !op.c8y_LogfileRequest.file">\n              <a ng-href="{{op.c8y_LogfileRequest.file}}" download>\n                <i c8y-icon="download"></i> {{\'Download\' | translate}}\n              </a>\n            </li>\n          </ul>\n        </span>\n      </div>\n\n      <div class="list-item-icon">\n        <i c8y-icon="{{statusIcon(op)}}" ng-class="statusClass(op)" uib-tooltip="{{op.status | translate}}"></i>\n      </div>\n\n      <div class="list-item-body">\n        <div class="row">\n          <div class="col-sm-6">\n            <span class="interact" ng-click="selectLogfile(op)">{{getOperationDesc(op) | translate}}</span> &nbsp;\n            <br class="visible-xs visible-sm">\n            <a class="text-muted" ng-href="#/device/{{op.deviceId}}">\n              <small><i c8y-icon="cog"></i>{{\'Device\' | translate}} {{op.deviceId}}</small>\n            </a>\n          </div>\n          <div class="col-sm-6" ng-click="selectLogfile(op)">\n            <small class="text-muted"><i c8y-icon="calendar"></i>{{op.c8y_LogfileRequest.dateFrom|absoluteDate}} &ndash; {{op.c8y_LogfileRequest.dateTo|absoluteDate}}</small>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <div uib-collapse="!op===selectedLog">\n      <div class="row" ng-if="op===selectedLog && isSuccessful(selectedLog)">\n        <div class="col-sm-3">\n          <div class="legend form-block" translate>Details</div>\n          <dl class="dl-inline small text-muted" style="margin-bottom: 0" ng-show="selectedLog.c8y_LogfileRequest.dateFrom">\n            <dt translate>Date from</dt>\n            <dd ng-bind="selectedLog.c8y_LogfileRequest.dateFrom|absoluteDate"></dd>\n          </dl>\n\n          <dl class="dl-inline small text-muted" style="margin-bottom: 0" ng-show="selectedLog.c8y_LogfileRequest.dateTo">\n            <dt translate>Date to</dt>\n            <dd ng-bind="selectedLog.c8y_LogfileRequest.dateTo | absoluteDate"></dd>\n          </dl>\n\n          <dl class="dl-inline small text-muted" style="margin-bottom: 0" ng-show="selectedLog.c8y_LogfileRequest.logFile">\n            <dt translate>Type of log to</dt>\n            <dd ng-bind="selectedLog.c8y_LogfileRequest.logFile"></dd>\n          </dl>\n\n          <dl class="dl-inline small text-muted" style="margin-bottom: 0" ng-show="selectedLog.c8y_LogfileRequest.searchText">\n            <dt translate>Filtered by text</dt>\n            <dd style="white-space: pre" ng-bind="selectedLog.c8y_LogfileRequest.searchText"></dd>\n          </dl>\n          <dl class="dl-inline small text-muted" style="margin-bottom: 0" g-show="selectedLog.c8y_LogfileRequest.maximumLines">\n            <dt translate>Last N lines</dt>\n            <dd ng-bind="selectedLog.c8y_LogfileRequest.maximumLines"></dd>\n          </dl>\n        </div>\n        <div class="col-sm-9">\n          <div class="legend form-block" translate>Log</div>\n          <c8y-log-viewer></c8y-log-viewer>\n        </div>\n\n\n      </div>\n    </div>\n\n    </div>\n  </div><!-- /.list-group -->\n  <c8y-load-more change-page-size></c8y-load-more>\n</div>\n',e.put("devicemanagement_logViewer/views/index.html",n),e.put("/apps/devicemanagement/logViewer/views/index.html",n)}angular.module("c8y.logViewer").run(["$templateCache",e])}();