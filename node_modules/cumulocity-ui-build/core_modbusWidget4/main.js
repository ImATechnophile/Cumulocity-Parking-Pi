/* core_modbusWidget4 8.21.0 2018-01-30T22:08:57+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
!function(){"use strict";function e(e){e.init()}e.$inject=["modbusWidgetUiProvider"],angular.module("c8y.modbusWidget4",[]).config(e)}(),function(){"use strict";function e(e,n){function t(){l()}function l(){e.add(m)}var a="Modbus Device Widget",i=n("Fieldbus device widget"),o=n("Allows for seeing status and operating modbus device"),s="core_modbusWidget4/",m={name:a,nameDisplay:i,description:o,templateUrl:s+"widget.html",configTemplateUrl:s+"config.html",showIf:["c8yFieldbus",function(e){return e.isApplicationAvailable()}]};return{init:t,registerWidget:l,$get:_.constant({})}}e.$inject=["c8yComponentsProvider","gettext"],angular.module("c8y.modbusWidget4").provider("modbusWidgetUi",e)}(),function(){"use strict";function e(e,n,t,l,a){function i(n){var t=e.when([]),l=_.get(n,"device");return l&&(t=o(l).then(function(e){return m(e,n)})),t}function o(a){var i=e.when(a),o=n.getId(a);return l.isFieldbusDevice(a)||(i=t.detail(o).then(n.getResData)),i}function s(e){return t.detailRealtime(e)}function m(e,n){var t=_.get(n,"categoriesConfig",[]);return u(e).then(function(l){var i=c(e,l);if(i.length>0){var o=_.groupBy(i,f);t=_.map(t,function(e){var t=_.get(o,e.name);return _.defaults(e,{label:e.name||a("Uncategorized")}),e.elements=d(e.elements,i,l),e.elements=r(e.elements,t,l,n),e}),g(t,o,l,n)}else t=[];return t})}function u(e){return l.getDeviceTypeFromDevice(e)}function c(e,n){var t=l.getElementsWithMeta(n);return e.c8y_ModbusDevice||(t=_.filter(t,b)),t}function d(e,n,t){return _.map(e,function(e){var a,i=l.findElementBestMatchingRefId(n,e.refId,e.type);return i&&(a=_.defaults(e,{name:i.name,type:i.meta.type.value,typeLabel:l.getElementTypeLabel(i,t),show:!0,label:i.name})),a})}function r(e,n,t,a){return _.forEach(n,function(n){_.find(e,{refId:l.getElementRefId(n)})||e.push({refId:l.getElementRefId(n),label:n.name,show:w(n,a),name:n.name,type:n.meta.type.value,typeLabel:l.getElementTypeLabel(n,t)})}),e}function g(e,n,t,i){_.forEach(n,function(n,o){_.find(e,{name:o})||e.push({name:o,label:o||a("Uncategorized"),elements:_.map(n,function(e){return{refId:l.getElementRefId(e),label:e.name,show:w(e,i),name:e.name,type:e.meta.type.value,typeLabel:l.getElementTypeLabel(e,t)}})})})}function v(n){var t=_.get(n,"device.id"),a=s(t),i=a.then(u),o=e.when(_.get(n,"categoriesConfig",p(t,n)));return e.all({fieldbusDevice:a,deviceType:i,categoriesConfig:o}).then(function(e){var n=c(e.fieldbusDevice,e.deviceType),t=_.map(e.categoriesConfig,function(e){return e.elements=_.map(e.elements,function(e){var t=l.findElementBestMatchingRefId(n,e.refId,e.type);return t&&(_.assign(e,t),e=_.defaults(e,{label:t.name,show:!0})),e}),_.defaults(e,{label:e.name})});return _.forEach(t,function(e){e.elements=_.filter(e.elements,"show")}),{device:e.fieldbusDevice,categories:t}})}function p(e,n){var t=[];return o(e).then(function(e){return u(e).then(function(l){var a=c(e,l),i=_.groupBy(a,f);return g(t,i,l,n),t})})}function b(e){return e.meta.type===l.ElementType.REGISTER&&!e.input}function f(e){return e.category||""}function h(e){return _.some(e,function(e){return _.some(e.elements,"show")})}function y(e,n){var t=_.map(n,function(e){return{name:e.name,label:e.label,elements:_.compact(_.map(e.elements,function(e){return e.show?_.pick(e,["refId","label","type"]):void 0}))}},[]);_.set(e,"categoriesConfig",t),_.unset(e,"coils"),_.unset(e,"registers")}function w(e,n){return E(e)?I(e,n):C(e,n)}function E(e){return e.meta.type===l.ElementType.REGISTER}function I(e,n){var t=_.includes(n.registers,e.id);return t||(t=_.includes(n.registers,[e.input,e.number,e.startBit].join(","))),t||(t=_.includes(n.registers,e.number)),t||(t=!!_.find(n.registers,{number:e.number,startBit:e.startBit})),t}function C(e,n){var t=_.includes(n.coils,e.id);return t||(t=_.includes(n.coils,[e.input,e.number].join(","))),t||(t=_.includes(n.coils,e.number)),t}return{getConfigModel:i,updateConfigModel:y,getWidgetModel:v,isAtLeastOneElementSelected:h,isDiscreteIOSelectedInConfig:window.c8y_testing&&C,isRegisterSelectedInConfig:window.c8y_testing&&I}}e.$inject=["$q","c8yBase","c8yDevices","c8yDeviceDatabase","gettext"],angular.module("c8y.modbusWidget4").factory("modbusWidgetSvc",e)}(),function(){"use strict";function e(e,n){function t(){l()}function l(){n.getConfigModel(e.config).then(function(e){o.categoriesConfig=e})}function a(t){t&&i(t)&&n.updateConfigModel(e.config,t)}function i(t){var l=n.isAtLeastOneElementSelected(t);return e.forms.componentForm.modbusWidgetValidation.$setValidity("at-least-one-field-selected",l),o.atLeastOneElementSelected=l,l}var o=this;e.$watch("config.device",t),e.$watch("vm.categoriesConfig",a,!0)}e.$inject=["$scope","modbusWidgetSvc"],angular.module("c8y.modbusWidget4").controller("modbusWidgetConfigCtrl",e)}(),function(){"use strict";function e(e,n,t,l,a,i,o,s){function m(){i.getWidgetModel(e.child.config).then(function(e){_.assign(h,e)})}function u(e){return e.meta.enumType&&e.meta.enumValues&&2===e.meta.enumValues.length}function c(e){return e.meta.enumType&&e.meta.enumValues&&(1===e.meta.enumValues.length||e.meta.enumValues.length>2)}function d(e){return!e.meta.enumType}function r(e,n){var l="";return a.canUpdateElement(h.device,n)&&(l=t.validationHints(e,{required:o("This field is required!"),"value-in-register-range":s.getString(y,n&&n.meta&&n.meta.valuesRange.custom)})),l}function g(e){w.push(e)}function v(e){w=_.without(w,e),p(500)}function p(e){n(b,e)}function b(){_.forEach(h.categories,function(e){_.forEach(e.elements,function(e){f(e)||(e.meta.type===l.ElementType.DISCRETE_IO&&(e.valueObj=_.find(e.meta.enumValues,{value:a.getCurrentElementValue(h.device,e)})),e.meta.type===l.ElementType.REGISTER&&(e.meta.enumType?e.valueObj=_.find(e.meta.enumValues,{value:a.getCurrentElementValue(h.device,e)}):(e.valueObj=e.valueObj||{},e.valueObj.value=a.getCurrentElementValue(h.device,e))))})})}function f(e){return a.isElementChangePending(e)||_.includes(w,e)}var h=this,y=o("Value out of range! Allowed values from {{min | number}} to {{max | number}} with step {{step | number}}. Use up/down arrows to find nearest possible value."),w=[];_.assign(h,{isElementChangePending:a.isElementChangePending,canUpdateElement:a.canUpdateElement,updateElement:a.updateElement,shouldShowSwitch:u,shouldShowEnumSelect:c,shouldShowNumberInput:d,validationHints:r,focus:g,blur:v}),e.$watch("child.config",m),e.$watch("vm.categories",p,!0),e.$watch("vm.device",p,!0)}e.$inject=["$scope","$timeout","c8yBase","c8yDeviceDatabase","c8yModbusDevice","modbusWidgetSvc","gettext","gettextCatalog"],angular.module("c8y.modbusWidget4").controller("modbusWidgetCtrl",e)}(),function(){"use strict";function e(e){var n;n='<div ng-controller="modbusWidgetConfigCtrl as vm">\n  <div class="alert alert-warning" ng-show="vm.categoriesConfig.length === 0" translate>\n    No categories available.\n  </div>\n\n  <div ui-sortable="{handle: \'.handle-category\'}" ng-model="vm.categoriesConfig">\n    <div class="panel panel-default" ng-repeat="category in vm.categoriesConfig" style="margin-bottom: 2px">\n      <div class="panel-heading">\n        <div class="flex-row">\n          <div class="handle-category">\n            <i c8y-icon="bars" style="cursor: move"></i>\n          </div>\n\n          <div class="ui-sortable-title">\n            <label class="editable" ng-if="category.name">\n              <input class="form-control" ng-model="category.label">\n              <span>{{category.label}}</span>\n            </label>\n            <label class="editable text-muted" ng-if="!category.name">\n              <span>{{category.label | translate}}</span>\n            </label>\n          </div>\n\n          <div class="ui-sortable-actions text-right">\n            <button class="btn btn-link" ng-click="category.isExpanded = !category.isExpanded">\n              <i c8y-icon="chevron-down" ng-if="!category.isExpanded"></i>\n              <i c8y-icon="chevron-up" ng-if="category.isExpanded"></i>\n            </button>\n          </div>\n        </div>\n      </div>\n      <div class="panel-body" uib-collapse="!category.isExpanded">\n        <table class="table table-vertical-middle form-group">\n          <thead>\n            <th style="width:5%">\n            </th>\n            <th style="width:5%">\n              <label>{{\'Show\' | translate}}</label>\n            </th>\n            <th style="width:34%">\n              <label>{{\'Label\' | translate}}</label>\n            </th>\n            <th style="width:28%">\n              <label>{{\'Name\' | translate}}</label>\n            </th>\n            <th style="width:28%">\n              <label>{{\'Type\' | translate}}</label>\n            </th>\n          </thead>\n          <tbody ui-sortable="{handle: \'.handle-property\'}" ng-model="category.elements">\n            <tr class="property" ng-repeat="element in category.elements">\n              <td style="width:5%" class="handle-property">\n                <i c8y-icon="bars" style="cursor: move"></i>\n              </td>\n              <td style="width:5%; vertical-align: middle">\n                <label class="c8y-checkbox input-sm" style="line-height: 30px">\n                  <input type="checkbox" ng-model="element.show">\n                  <span></span>\n                </label>\n              </td>\n              <td style="width:34%">\n                <label class="editable">\n                  <input class="form-control" ng-model="element.label">\n                  <span>{{element.label}}</span>\n                </label>\n              </td>\n              <td style="width:28%">\n                {{element.name}}\n              </td>\n              <td style="width:28%">\n                {{element.typeLabel | translate}}\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n    </div>\n  </div>\n\n  <input type="hidden" name="modbusWidgetValidation" ng-model="modbusWidgetValidation"/>\n\n  <p ng-if="vm.categoriesConfig.length > 0 && !vm.atLeastOneElementSelected" style="margin-top: 20px" class="has-error">\n    <span style="display: inline-block" class="help-block">\n      <i c8y-icon="exclamation-triangle"></i>\n      <span translate>\n        At least one field needs to be selected.\n      </span>\n    </span>\n  </p>\n</div>\n',e.put("core_modbusWidget4/config.html",n),e.put("/apps/core/modbusWidget4/config.html",n),n='<div ng-controller="modbusWidgetCtrl as vm" class="modbusWidget" ng-init="wgtId = \'wgt\' + $id">\n  <div ng-repeat="category in vm.categories" ng-if="category.elements.length > 0" ng-init="catId = \'c\' + $index;" class="card-block">\n    <div ng-show="category.name" class="legend form-block">\n      {{category.label}}\n    </div>\n    <div ng-repeat="element in category.elements" ng-init="elmId = \'e\' + $index">\n      <div class="modbus-category form-group">\n        <label for="{{wgtId+\'_\'+catId+\'_\'+elmId}}" ng-class="{\'notEditable\': !vm.canUpdateElement(vm.device, element)}" title="{{element.name}}">\n          {{element.label}}\n        </label>\n        <i c8y-icon="circle-o-notch" class="fa-spin" ng-style="{visibility: vm.isElementChangePending(element) ? \'initial\' : \'hidden\'}"></i>\n\n        <div class="form-group" ng-if="vm.shouldShowSwitch(element)">\n          <button type="button" class="btn btn-default" style="z-index: 2" ng-disabled="!vm.canUpdateElement(vm.device, element) || vm.isElementChangePending(element)" uib-btn-checkbox btn-checkbox-true="element.meta.enumValues[1]" btn-checkbox-false="element.meta.enumValues[0]" ng-model="element.valueObj" ng-change="vm.updateElement(vm.device, element, element.valueObj)" title="{{element.valueObj.label}}">\n            <span ng-bind="element.valueObj.label"></span>\n          </button>\n        </div>\n        <form name="vm.elementValueForm" ng-if="vm.shouldShowEnumSelect(element) || vm.shouldShowNumberInput(element)" ng-submit="vm.updateElement(vm.device, element, element.valueObj)" novalidate>\n          <div class="c8y-select-wrapper" ng-if="vm.shouldShowEnumSelect(element)">\n            <select id="{{wgtId+\'_\'+catId+\'_\'+elmId}}" name="selectInput" class="form-control" ng-model="element.valueObj" ng-change="vm.updateElement(vm.device, element, element.valueObj)" ng-options="enumValue as enumValue.label for enumValue in element.meta.enumValues" ng-required="vm.shouldShowEnumSelect(element)" ng-disabled="vm.isElementChangePending(element) || !vm.canUpdateElement(vm.device, element)" ng-focus="vm.focus(element)" ng-blur="vm.blur(element)">\n            </select>\n            <span></span>\n          </div>\n          <div class="input-group" ng-if="vm.shouldShowNumberInput(element)" style="width: 100%" ng-class="{\'has-error\': vm.elementValueForm.numberInput.$dirty && vm.elementValueForm.numberInput.$invalid}" uib-tooltip="{{vm.validationHints(vm.elementValueForm.numberInput, element)}}" tooltip-append-to-body="true">\n            <input id="{{wgtId+\'_\'+catId+\'_\'+elmId}}" name="numberInput" class="form-control text-right" ng-class="{\'input-border\': vm.canUpdateElement(vm.device, element)}" type="number" validate-value-in-register-range="element.meta.valuesRange.custom" ng-required="vm.canUpdateElement(vm.device, element) && vm.shouldShowNumberInput(element)" ng-disabled="!vm.canUpdateElement(vm.device, element) || vm.isElementChangePending(element)" ng-model="element.valueObj.value" min="{{element.meta.valuesRange.custom.min}}" max="{{element.meta.valuesRange.custom.max}}" step="{{element.meta.valuesRange.custom.step}}" ng-focus="vm.focus(element)" ng-blur="vm.blur(element)">\n            <span class="input-group-addon" ng-show="element.unit && vm.shouldShowNumberInput(element)" title="{{element.unit}}" ng-bind="element.unit"></span>\n            <span class="input-group-btn" ng-if="vm.canUpdateElement(vm.device, element)">\n              <button class="btn btn-primary" ng-disabled="vm.isElementChangePending(element) || !vm.canUpdateElement(vm.device, element) || vm.elementValueForm.$invalid" translate>Set</button>\n            </span>\n          </div>\n        </form>\n      </div>\n    </div>\n  </div>\n</div>\n',e.put("core_modbusWidget4/widget.html",n),e.put("/apps/core/modbusWidget4/widget.html",n)}angular.module("c8y.modbusWidget4").run(["$templateCache",e])}();