/* devicemanagement_deviceShell 8.21.0 2018-01-30T22:08:29+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
angular.module("c8y.deviceShell",[]).config(["c8yViewsProvider","gettext",function(e,n){var t="terminal",a=n("Shell"),i="/device/:deviceId",c="devicemanagement_deviceShell/views/";e.when(i,{name:a,icon:t,templateUrl:c+"index.html",showIf:["$routeParams","c8yBase","c8yDevices",function(e,n,t){return t.detailCached(e.deviceId).then(n.getResData).then(function(e){return t.supportsOperation(e,"c8y_Command")})}]})}]),function(){"use strict";function e(e,n,t,a,i,c,o,l,m,s,d){function r(){u(),p(),f()}function u(){e.command={text:""}}function p(){v().then(g)}function v(){var e={deviceId:n.deviceId,pageSize:F,fragmentType:"c8y_Command",revert:!0};return c.list(i.timeOrderFilter(e))}function g(n){e.operations=n}function f(){o.canSendCommandsViaSMS().then(function(n){e.smsEnabled=n})}function h(e){return y(e,!0)}function y(n,t){e.sendingCommand=!0;var a=b(n,t);return c.createWithNotifications(a).then(function(e){return e.created.then(_.partial(T,a)),e.completed.then(_.partial(S,a),_.noop,_.partial(S,a)),e.created}).finally(function(){n.text="",e.sendingCommand=!1})}function b(e,t){return{deviceId:n.deviceId,description:d("Execute shell command")+(e.name?": "+e.name:""),deliveryType:t?"SMS":void 0,c8y_Command:{text:e.text}}}function T(e,n){c.detail(n).then(i.getResData).then(function(n){m.success(d("Command has been sent!")),_.assign(e,n),w(e)})}function S(e,n){m.success(d("Command's status has been updated!")),_.assign(e,n)}function w(n){e.operations.push(n),C(n)}function C(e){A.length=0,x(e)}function x(e){if(E(e)){var n=A.indexOf(e);A.splice(n,1)}else A.push(e)}function E(e){return A.indexOf(e)>-1}function M(){t.url(k())}function k(){return"/device/"+n.deviceId+"/control?fragmentType=c8y_Command"}function I(){l({templateUrl:"devicemanagement_deviceShell/views/commandTemplates.html",controller:"commandTemplatesCtrl"}).then(function(n){"USE"===n.action?(e.command.name=n.commandTemplate.name,e.command.text=n.commandTemplate.text,U.refresh()):"EXECUTE"===n.action&&y(n.commandTemplate,n.useSMS)})}function D(){s.detail(n.deviceId).then(i.getResData).then($)}function $(n){e.device=n,e.transp=P()}function P(){var n=e.device,t=(n||{})[q],a=t&&t[W],i=_.find(B,{val:V});return a&&(i=_.find(B,{val:a})),i}function R(n){if(!n)return!0;if(e.changingTransportMode)return d("An operation to change transport mode is currently in progress.");if("sms"===n.val){var t=e.device,a=(t||{}).c8y_Mobile||{},i=a.msisdn;if(!i)return d("The MSISDN is not defined.")}return n.val===P().val&&d("This is currently defined communication mode")}function N(n){var t=e.device,a=_.cloneDeep(t[q]||{}),i={deviceId:t.id};i[q]=a,a[W]=n.val,e.changingTransportMode=!0,c.createWithNotifications(i).then(function(e){e.created.then(function(){m.info(d("Operation to change communication mode successfully created!"))},O),e.completed.then(function(){D(),m.success(d("Communication mode successfully changed!"))}).finally(O)})}function O(){e.changingTransportMode=!1}var A=[],U={},F=3,V="IP",B=[{val:"IP",display:"IP"},{val:"SMS",display:"SMS"}],q="c8y_CommunicationMode",W="mode";D(),e.canChangeTransport=R,e.changeTransport=N,e.execute=y,e.executeSMS=h,e.transportMode=P,e.transportModes=B,e.toggle=x,e.isOpen=E,e.cancel=c.cancel,e.viewHistory=M,e.getViewHistoryLink=k,e.getPredefinedCommand=I,e.deviceStatus=U,r()}angular.module("c8y.deviceShell").controller("deviceShellCtrl",["$scope","$routeParams","$location","$q","c8yBase","c8yDeviceControl","c8yDeviceShell","c8yModal","c8yAlert","c8yInventory","gettext",e])}(),function(){"use strict";function e(e,n,t,a,i,c,o,l,m,s){function d(){r(),g(),E()}function r(){u(n.deviceId).then(v)}function u(e){return i.detailCached(e).then(a.getResData).then(p).then(c.getCommandTemplatesForDeviceType)}function p(e){return M=e.type}function v(e){k.length=0,_.forEach(e,function(e){var n=!!e.id;k.push({name:n?e.name:s.getString(e.name),command:e.command,category:n?e.category:s.getString(e.category),id:e.id})})}function g(){c.canSendCommandsViaSMS().then(function(n){e.smsEnabled=n})}function f(){e.result.action="USE";var n=e.result.commandTemplate=_.clone(e.result.commandTemplate);n.text=n.text||n.command,t.close(e.result)}function h(n){e.result.action="EXECUTE",e.result.useSMS=n||!1;var a=e.result.commandTemplate=_.clone(e.result.commandTemplate);a.text=a.command,t.close(e.result)}function y(){h(!0)}function b(){e.newCommandTemplate?delete e.newCommandTemplate:t.dismiss()}function T(){c.saveTemplate(e.newCommandTemplate).then(a.getResData).then(function(n){var t=_.pick(n,["id","name","category","command","text"]),a=_.find(k,{id:t.id});a?_.assign(a,t):k.unshift(t),I.commandTemplate=t,delete e.newCommandTemplate})}function S(){return!!e.newCommandTemplate}function w(){e.newCommandTemplate={deviceType:M}}function C(n){e.newCommandTemplate=n}function x(n){e.result.commandTemplate===n&&delete e.result.commandTemplate,c.removeTemplate(n).then(function(){_.pull(k,n)}).then(function(){l.success(m("Shell command template removed."))})}function E(){o.hasAnyRole(["ROLE_INVENTORY_ADMIN"]).then(function(n){e.canWrite=n})}var M,k=[],I={action:null,commandTemplate:null};_.assign(e,{commandTemplates:k,result:I,forms:{},use:f,execute:h,executeSMS:y,cancel:b,save:T,addNew:w,hideAddButton:S,edit:C,remove:x,appendToEl:document.getElementsByClassName("modal")}),d()}e.$inject=["$scope","$routeParams","$uibModalInstance","c8yBase","c8yDevices","c8yDeviceShell","c8yPermissions","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.deviceShell").controller("commandTemplatesCtrl",e)}(),angular.module("c8y.deviceShell").controller("deviceStatusCtrl",["$scope","$routeParams","c8yBase","c8yDevices","c8yDeviceStatus","gettext",function(e,n,t,a,i,c){"use strict";function o(){return e.refreshing=!0,a.detail(n.deviceId).then(t.getResData).then(l).finally(function(){e.refreshing=!1})}function l(n){e.device=n}function m(){return c(i.canReceiveCommands(e.device)?"Device is ready to receive commands":"Device is offline")}e.refresh=o,e.getStatus=m,o()}]),angular.module("c8y.deviceShell").directive("deviceStatus",function(){"use strict";return{restrict:"E",templateUrl:"devicemanagement_deviceShell/views/deviceStatus.html",controller:"deviceStatusCtrl",scope:{device:"=",refresh:"="}}}),function(){"use strict";function e(e){var n;n='\n<div class="card">\n  <div class="card-header">\n    <h4 class="card-title"><i c8y-icon="terminal"></i> {{\'Command\' | translate}}</h4>\n    <div class="flex-item-right">\n      <device-status device="deviceStatus.device" refresh="deviceStatus.refresh"></device-status>\n    </div>\n  </div>\n  <hr>\n  <div class="card-block">\n    <textarea class="form-control" rows="1" ng-model="command.text"></textarea>\n  </div>\n  <div class="card-footer separator">\n    <button type="button" class="btn btn-primary" ng-click="execute(command)" ng-disabled="!command.text || sendingCommand" translate="">Execute</button>\n    <button type="button" class="btn btn-primary" ng-click="executeSMS(command)" ng-disabled="!smsEnabled || !command.text || sendingCommand" translate="">Execute (SMS)</button>\n  </div>\n</div>\n',e.put("devicemanagement_deviceShell/views/command.html",n),e.put("/apps/devicemanagement/deviceShell/views/command.html",n),n='<div class="modal-header text-center">\n  <h3 translate style="margin-bottom: 10px">Select a predefined command</h3>\n  <form ng-hide="newCommandTemplate" class="commandTemplatesSearchForm">\n    <div class="input-group input-group-search">\n      <input type="search" class="form-control" placeholder="{{\'Search command by name or text\' | translate}}" ng-model="commandsFilter.text">\n      <span class="input-group-addon">\n        <i c8y-icon="search"></i>\n      </span>\n    </div>\n  </form>\n</div>\n<div class="modal-inner-scroll">\n  <div class="command-templates-list list-group">\n\n    <div class="modal-body">\n      <button class="btn-add-block" ng-click="addNew()" ng-show="canWrite && !newCommandTemplate">\n        <i c8y-icon="plus-square"></i> {{\'Add new\' | translate}}\n      </button>\n\n      <form name="forms.newCommandForm" ng-if="newCommandTemplate">\n        <div class="form-group">\n          <label translate>Name</label>\n          <input required class="form-control" ng-model="newCommandTemplate.name">\n        </div>\n        <div class="form-group">\n          <label translate>Category</label>\n          <input required class="form-control" ng-model="newCommandTemplate.category">\n        </div>\n        <div class="form-group">\n          <label translate>Command template</label>\n          <textarea required class="form-control" rows="1" ng-model="newCommandTemplate.command"></textarea>\n        </div>\n      </form>\n    </div>\n\n    <div ng-hide="newCommandTemplate">\n      <div ng-repeat="commandTemplate in commandTemplates | filter:commandsFilter.text" class="list-group-item flex-row" ng-class="{\'active\': result.commandTemplate === commandTemplate}" ng-click="result.commandTemplate = commandTemplate">\n\n        <div class="list-item-actions" ng-if="commandTemplate.id && canWrite" ng-click="$event.stopPropagation()">\n          <div uib-dropdown dropdown-append-to="appendToEl" is-open="isOpen" class="dropdown settings" ng-class="{\'open\': isOpen}">\n            <button class="dropdown-toggle c8y-dropdown" uib-dropdown-toggle title="{{\'Actions\' | translate}}">\n              <i c8y-icon="ellipsis-v"></i>\n            </button>\n            <ul class="dropdown-menu dropdown-menu-right" uib-dropdown-menu>\n              <li>\n                <a href="" ng-click="edit(commandTemplate)">\n                  <i c8y-icon="edit"></i> {{\'Edit\' | translate}}\n                </a>\n              </li>\n              <li>\n                <a href="" ng-click="remove(commandTemplate)">\n                  <i c8y-icon="trash"></i> {{\'Remove\' | translate}}\n                </a>\n              </li>\n            </ul>\n          </div>\n        </div>\n        <div class="list-item-body">\n          <span ng-show="commandTemplate.category" style="max-width:200px" class="label label-info pull-right text-truncate" title="{{commandTemplate.category | translate}}">\n            {{commandTemplate.category | translate}}\n          </span>\n          <span class="text-truncate list-group-item-heading" title="{{commandTemplate.name | translate}}">\n            {{commandTemplate.name | translate}}\n          </span>\n          <span class="list-group-item-text">\n            <small ng-class="{\'text-muted\': result.commandTemplate != commandTemplate}">\n              {{commandTemplate.command}}\n            </small>\n          </span>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n<div class="modal-footer">\n  <button type="button" class="btn btn-default" ng-click="cancel()" translate="">Cancel</button>\n  <button type="button" class="btn btn-primary" ng-click="use()" ng-disabled="!result.commandTemplate" ng-hide="newCommandTemplate" translate>Use</button>\n  <button type="button" class="btn btn-primary" ng-click="execute()" ng-disabled="!result.commandTemplate" ng-hide="newCommandTemplate" translate>Execute</button>\n  <button type="button" class="btn btn-primary" ng-click="executeSMS()" ng-disabled="!result.commandTemplate || !smsEnabled" ng-hide="newCommandTemplate" translate>Execute (SMS)</button>\n  <button type="button" class="btn btn-primary" ng-click="save()" ng-disabled="forms.newCommandForm.$invalid" ng-show="newCommandTemplate" translate>Save</button>\n</div>\n',e.put("devicemanagement_deviceShell/views/commandTemplates.html",n),e.put("/apps/devicemanagement/deviceShell/views/commandTemplates.html",n),n='\n<small class="text-right">\n  {{getStatus() | translate}}\n  <button class="btn btn-link btn-xs" style="padding:0" ng-click="refresh()" title="{{\'Refresh device status\' | translate}}">\n    <i c8y-icon="refresh" ng-class="{\'fa-spin\': refreshing}"></i>\n  </button>\n</small>\n',e.put("devicemanagement_deviceShell/views/deviceStatus.html",n),e.put("/apps/devicemanagement/deviceShell/views/deviceStatus.html",n),n='<div ng-controller="deviceShellCtrl">\n\n  <c8y-ui-action-bar-set>\n    <a ng-href="#{{getViewHistoryLink()}}" class="btn btn-link pull-right">\n      <i c8y-icon="history"></i> {{\'View history\' | translate}}\n    </a>\n\n    <button type="button" class="btn btn-link" ng-click="getPredefinedCommand()">\n      <i c8y-icon="terminal"></i> {{\'Get predefined command\' | translate}}\n    </button>\n  </c8y-ui-action-bar-set>\n\n  <div class="row">\n    <div class="col-md-6" ng-include="\'devicemanagement_deviceShell/views/command.html\'"></div>\n    <div class="col-md-6">\n      <c8y-ui-operations-timeline operations="operations">\n      </c8y-ui-operations-timeline>\n    </div>\n  </div>\n</div>\n',e.put("devicemanagement_deviceShell/views/index.html",n),e.put("/apps/devicemanagement/deviceShell/views/index.html",n)}angular.module("c8y.deviceShell").run(["$templateCache",e])}();